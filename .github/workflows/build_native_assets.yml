name: Build Native Assets

on:
  push:
    tags:
      - 'v*'
    branches:
      - ci
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  build-macos:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Build ARM64
        working-directory: rust
        run: |
          cargo build --release --target aarch64-apple-darwin

      - name: Build x86_64
        working-directory: rust
        run: |
          cargo build --release --target x86_64-apple-darwin

      - name: Create Universal Binary
        working-directory: rust
        run: |
          # Get the library name from Cargo.toml
          LIB_NAME=$(grep '^name' Cargo.toml | head -n1 | cut -d'"' -f2 | tr '-' '_')
          
          # Create universal binary using lipo
          lipo -create \
            target/aarch64-apple-darwin/release/lib${LIB_NAME}.dylib \
            target/x86_64-apple-darwin/release/lib${LIB_NAME}.dylib \
            -output lib${LIB_NAME}_macos_universal.dylib
          
          # Verify it's actually universal
          file lib${LIB_NAME}_macos_universal.dylib
          lipo -info lib${LIB_NAME}_macos_universal.dylib

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        #        working-directory: rust
        with:
          name: macos-universal
          path: rust/lib*_macos_universal.dylib

      - name: Upload to Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: rust/lib*_macos_universal.dylib
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x64
          - target: aarch64-unknown-linux-gnu
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      # ðŸ‘‡ NEW: tell Rust which linker to use for aarch64
      - name: Configure aarch64 linker
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        working-directory: rust
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      - name: Build
        working-directory: rust
        run: |
          cargo build --release --target ${{ matrix.target }}

          # Get library name
          LIB_NAME=$(grep '^name' Cargo.toml | head -n1 | cut -d'"' -f2 | tr '-' '_')

          # Copy and rename
          cp target/${{ matrix.target }}/release/lib${LIB_NAME}.so \
             lib${LIB_NAME}_linux_${{ matrix.arch }}.so

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: rust/lib*_linux_${{ matrix.arch }}.so

      - name: Upload to Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: rust/lib*_linux_${{ matrix.arch }}.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  build-windows:
    name: Build Windows (${{ matrix.target }})
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        working-directory: rust
        run: |
          cargo build --release --target ${{ matrix.target }}
          
          # Get library name (PowerShell)
          $LIB_NAME = (Select-String -Path Cargo.toml -Pattern '^name\s*=\s*"(.+)"' | Select-Object -First 1).Matches.Groups[1].Value -replace '-','_'
          
          # Copy and rename
          Copy-Item "target/${{ matrix.target }}/release/${LIB_NAME}.dll" `
                    "${LIB_NAME}_windows_${{ matrix.arch }}.dll"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: rust/*_windows_${{ matrix.arch }}.dll

      - name: Upload to Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: rust/*_windows_${{ matrix.arch }}.dll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Build for iOS (requires different approach with xcframework)
  #  build-ios:
  #    name: Build iOS Universal
  #    runs-on: macos-latest
  #    steps:
  #      - uses: actions/checkout@v4
  #
  #      - name: Install Rust
  #        uses: dtolnay/rust-toolchain@stable
  #        with:
  #          targets: aarch64-apple-ios,x86_64-apple-ios
  #
  #      - name: Build ARM64 (Device)
  #        working-directory: rust
  #        run: cargo build --release --target aarch64-apple-ios
  #
  #      - name: Build x86_64 (Simulator)
  #        working-directory: rust
  #        run: cargo build --release --target x86_64-apple-ios
  #
  #      - name: Create Universal Library
  #        working-directory: rust
  #        run: |
  #          LIB_NAME=$(grep '^name' Cargo.toml | head -n1 | cut -d'"' -f2 | tr '-' '_')
  #
  #          lipo -create \
  #            target/aarch64-apple-ios/release/lib${LIB_NAME}.a \
  #            target/x86_64-apple-ios/release/lib${LIB_NAME}.a \
  #            -output lib${LIB_NAME}_ios_universal.a
  #
  #      - name: Upload Artifact
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: ios-universal
  #          path: rust/lib*_ios_universal.a
  #
  #      - name: Upload to Release
  #        if: startsWith(github.ref, 'refs/tags/')
  #        uses: softprops/action-gh-release@v1
  #        with:
  #          files: rust/lib*_ios_universal.a
  #        env:
  #          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Build for Android
  #  build-android:
  #    name: Build Android (${{ matrix.target }})
  #    runs-on: ubuntu-latest
  #    strategy:
  #      matrix:
  #        include:
  #          - target: aarch64-linux-android
  #            arch: arm64
  #          - target: armv7-linux-androideabi
  #            arch: armv7
  #          - target: x86_64-linux-android
  #            arch: x64
  #    steps:
  #      - uses: actions/checkout@v4
  #
  #      - name: Install Rust
  #        uses: dtolnay/rust-toolchain@stable
  #        with:
  #          targets: ${{ matrix.target }}
  #
  #      - name: Setup Android NDK
  #        uses: nttld/setup-ndk@v1
  #        with:
  #          ndk-version: r26d
  #
  #      - name: Build
  #        working-directory: rust
  #        env:
  #          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
  #        run: |
  #          cargo build --release --target ${{ matrix.target }}
  #
  #          LIB_NAME=$(grep '^name' Cargo.toml | head -n1 | cut -d'"' -f2 | tr '-' '_')
  #
  #          cp target/${{ matrix.target }}/release/lib${LIB_NAME}.so \
  #             lib${LIB_NAME}_android_${{ matrix.arch }}.so
  #
  #      - name: Upload Artifact
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: android-${{ matrix.arch }}
  #          path: rust/lib*_android_${{ matrix.arch }}.so
  #
  #      - name: Upload to Release
  #        if: startsWith(github.ref, 'refs/tags/')
  #        uses: softprops/action-gh-release@v1
  #        with:
  #          files: rust/lib*_android_${{ matrix.arch }}.so
  #        env:
  #          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}